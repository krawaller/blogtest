<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="/static/styles/nprogress.css"/><link rel="stylesheet" href="/static/styles/code.css"/><link rel="stylesheet" href="/static/styles/site.css"/><script async="" src="https://www.google-analytics.com/analytics.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-11433118-1', 'auto');
  ga("send", "pageview");</script><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta charSet="utf-8"/><title>A Reflux TodoMVC codebase walkthrough</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/2QsClKZj9MiqsQHek7Hru/pages/posts/a-reflux-todomvc-codebase-walkthrough.js" as="script"/><link rel="preload" href="/_next/static/2QsClKZj9MiqsQHek7Hru/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.71c37b6af41e6d908545.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-313fb35df81e158a12cf.js" as="script"/></head><body><div class="site"><div id="__next"><div style="margin-bottom:20px"></div><div class="master"><h1><a href="/">Krawaller</a></h1><hr/><div class="summary">A closer look at the code and data flow in the Reflux TodoMVC implementation</div><hr/><h2>A Reflux TodoMVC codebase walkthrough</h2><div class="page-content"><p>Tags: <a href="/tags/react">react</a> <a href="/tags/reflux">reflux</a> <a href="/tags/case_study">case study</a> <a href="/tags/todomvc">todomvc</a></p><div class="post" data-postid="refluxtodo"><h3 id="the-todomvc-project">The TodoMVC project</h3><p>Very likely you&#x27;re already familiar with <a href="http://todomvc.com/">TodoMVC</a>, <a href="http://addyosmani.com/">Addy Osmani</a>&#x27;s project to help comparing JavaScript frameworks. The idea is to code the exact same app in the different frameworks, and since we know the app, it&#x27;s easier to get an understanding for the framework that was used in the particular code version you&#x27;re looking at.</p><p>For this to work the app itself has to be very simple, and it is:</p><p><img src="../static/posts/a-reflux-todomvc-codebase-walkthrough/img/refluxtodoapp.png" alt="Reflux TodoMVC app"/></p><p>There is full CRUD for todo items, and some aggregation such as toggling all, clearing all finished items and filtering.</p><p>In spite of being simple, however, it turns out that it is still complex enough to enable building an understanding for what the framework in question takes like. Addy made an excellent job to hit that sweet spot, which is most likely the secret behind the popularity of the project.</p><h3 id="the-reflux-version">The Reflux version</h3><p>To help curious window shoppers check out <a href="https://github.com/spoike/refluxjs">Reflux</a>, creator <a href="http://spoike.ghost.io/">Mikael Brassman</a> made a <a href="https://github.com/spoike/refluxjs-todo">TodoMVC version</a> using Reflux, <a href="http://facebook.github.io/react/">React</a> and <a href="https://github.com/rackt/react-router">react-router</a>.</p><p>This post will walk through the code, although I&#x27;ll use <a href="https://github.com/krawaller/refluxjs-todo">my own fork</a> which has some modifications which at the time of writing haven&#x27;t been merged into the official repo.</p><h3 id="the-reflux-data-flow-model">The Reflux data flow model</h3><p>As detailed in our <a href="http://blog.krawaller.se/posts/the-reflux-data-flow-model/">post on the Reflux data flow model</a>, Reflux takes a global pubsub approach but negates the bad parts of that by having lots of parallell channel who all transmit just one kind of event.</p><p>We used this pucture to illustrate the model:</p><p><img src="../static/posts/a-reflux-todomvc-codebase-walkthrough/img/refluxflow2.jpeg" alt="Reflux data flow"/></p><p>As we will find, this model holds true for the TodoMVC app as well (apart from it not having a separate database).</p><h3 id="ready-set">Ready, set...</h3><p>First off - the actions. Since they are in essence a list of all available events in the app, and also serve as the glue between the Store and the components, the action definition is very central to the app. For the TodoMVC app they are located in <code>src/actions.js</code> and look like this:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> TodoActions = Reflux.createActions([<br/>    <span class="hljs-string">&quot;toggleItem&quot;</span>,<br/>    <span class="hljs-string">&quot;toggleAllItems&quot;</span>,<br/>    <span class="hljs-string">&quot;addItem&quot;</span>,<br/>    <span class="hljs-string">&quot;removeItem&quot;</span>,<br/>    <span class="hljs-string">&quot;clearCompleted&quot;</span>,<br/>    <span class="hljs-string">&quot;editItem&quot;</span><br/>]);</code></pre><h3 id="the-store-story">The Store story</h3><p>A central Store is listening to the actions and will update the todo data. Often by communicating with some kind of database API, as shown in the picture above, but in the Reflux TodoMVC app the Store merely uses localStorage.</p><p>Each store should just be concerned with one kind of data, so a larger app commonly consists of many stores. TodoMVC however only deals with todo items, and thus it only contains the one store. Here&#x27;s the code for that store, located in <code>src/store.js</code>:</p><pre><code class="hljs language-javascript"><span class="hljs-comment">// some variables and helpers for our fake database stuff</span><br/><span class="hljs-keyword">var</span> todoCounter = <span class="hljs-number">0</span>,<br/>    localStorageKey = <span class="hljs-string">&quot;todos&quot;</span>;<br/><br/><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getItemByKey</span>(<span class="hljs-params">list,itemKey</span>)</span>{<br/>    <span class="hljs-keyword">return</span> _.find(list, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{<br/>        <span class="hljs-keyword">return</span> item.key === itemKey;<br/>    });<br/>}<br/><br/><span class="hljs-keyword">var</span> todoListStore = Reflux.createStore({<br/>    <span class="hljs-comment">// this will set up listeners to all publishers in TodoActions, using onKeyname (or keyname) as callbacks</span><br/>    listenables: [TodoActions],<br/>    <span class="hljs-attr">onEditItem</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">itemKey, newLabel</span>) </span>{<br/>        <span class="hljs-keyword">var</span> foundItem = getItemByKey(<span class="hljs-keyword">this</span>.list,itemKey);<br/>        <span class="hljs-keyword">if</span> (!foundItem) {<br/>            <span class="hljs-keyword">return</span>;<br/>        }<br/>        foundItem.label = newLabel;<br/>        <span class="hljs-keyword">this</span>.updateList(<span class="hljs-keyword">this</span>.list);<br/>    },<br/>    <span class="hljs-attr">onAddItem</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">label</span>) </span>{<br/>        <span class="hljs-keyword">this</span>.updateList([{<br/>            <span class="hljs-attr">key</span>: todoCounter++,<br/>            <span class="hljs-attr">created</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),<br/>            <span class="hljs-attr">isComplete</span>: <span class="hljs-literal">false</span>,<br/>            <span class="hljs-attr">label</span>: label<br/>        }].concat(<span class="hljs-keyword">this</span>.list));<br/>    },<br/>    <span class="hljs-attr">onRemoveItem</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">itemKey</span>) </span>{<br/>        <span class="hljs-keyword">this</span>.updateList(_.filter(<span class="hljs-keyword">this</span>.list,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>)</span>{<br/>            <span class="hljs-keyword">return</span> item.key!==itemKey;<br/>        }));<br/>    },<br/>    <span class="hljs-attr">onToggleItem</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">itemKey</span>) </span>{<br/>        <span class="hljs-keyword">var</span> foundItem = getItemByKey(<span class="hljs-keyword">this</span>.list,itemKey);<br/>        <span class="hljs-keyword">if</span> (foundItem) {<br/>            foundItem.isComplete = !foundItem.isComplete;<br/>            <span class="hljs-keyword">this</span>.updateList(<span class="hljs-keyword">this</span>.list);<br/>        }<br/>    },<br/>    <span class="hljs-attr">onToggleAllItems</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">checked</span>) </span>{<br/>        <span class="hljs-keyword">this</span>.updateList(_.map(<span class="hljs-keyword">this</span>.list, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{<br/>            item.isComplete = checked;<br/>            <span class="hljs-keyword">return</span> item;<br/>        }));<br/>    },<br/>    <span class="hljs-attr">onClearCompleted</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">this</span>.updateList(_.filter(<span class="hljs-keyword">this</span>.list, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{<br/>            <span class="hljs-keyword">return</span> !item.isComplete;<br/>        }));<br/>    },<br/>    <span class="hljs-comment">// called whenever we change a list. normally this would mean a database API call</span><br/>    updateList: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">list</span>)</span>{<br/>        localStorage.setItem(localStorageKey, <span class="hljs-built_in">JSON</span>.stringify(list));<br/>        <span class="hljs-comment">// if we used a real database, we would likely do the below in a callback</span><br/>        <span class="hljs-keyword">this</span>.list = list;<br/>        <span class="hljs-keyword">this</span>.trigger(list); <span class="hljs-comment">// sends the updated list to all listening components (TodoApp)</span><br/>    },<br/>    <span class="hljs-comment">// this will be called by all listening components as they register their listeners</span><br/>    getDefaultData: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">var</span> loadedList = localStorage.getItem(localStorageKey);<br/>        <span class="hljs-keyword">if</span> (!loadedList) {<br/>            <span class="hljs-comment">// If no list is in localstorage, start out with a default one</span><br/>            <span class="hljs-keyword">this</span>.list = [{<br/>                <span class="hljs-attr">key</span>: todoCounter++,<br/>                <span class="hljs-attr">created</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),<br/>                <span class="hljs-attr">isComplete</span>: <span class="hljs-literal">false</span>,<br/>                <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;Rule the web&#x27;</span><br/>            }];<br/>        } <span class="hljs-keyword">else</span> {<br/>            <span class="hljs-keyword">this</span>.list = _.map(<span class="hljs-built_in">JSON</span>.parse(loadedList), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{<br/>                <span class="hljs-comment">// just resetting the key property for each todo item</span><br/>                item.key = todoCounter++;<br/>                <span class="hljs-keyword">return</span> item;<br/>            });<br/>        }<br/>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.list;<br/>    }<br/>});<br/></code></pre><p>Quite a mouthful, but if you bear with it the structure is rather clear! Each action is caught in a callback which changes the data and calls <code>updateList</code>, which in turn stores the new data and <code>triggers</code> it to all listeners.</p><p>The initial load from localStorage is done in <code>getDefaultData</code>, which is what all listeners is initially seeded with when they first register their interest.</p><h3 id="a-component-overview">A component overview</h3><p>Before we dive into the individual components, here&#x27;s a high-level look at how they are related, and where the various action calls are located:</p><p><img src="../static/posts/a-reflux-todomvc-codebase-walkthrough/img/refluxtodocomps.png" alt="Reflux TodoMVC components"/></p><p>As you can see the app is made up from 5 different components, all defined in <code>src/components.jsx.js</code>.</p><h3 id="the-react-router-root">The React router root</h3><p>However, the app doesn&#x27;t start with <code>TodoApp</code>, but with a router definition using <code>ReactRouter</code>! This is used to handle the different routes that the app is supposed to contain; the root (showing all todos), <code>completed</code> showing only completed todos, and <code>active</code> showing only those who haven&#x27;t been completed.</p><p>Here&#x27;s the code, located at the bottom of <code>src/components.jsx.js</code>:</p><pre><code class="hljs language-javascript"><span class="hljs-keyword">var</span> routes = (<br/>    &lt;ReactRouter.Route handler={TodoApp}&gt;<br/>        &lt;ReactRouter.Route name=&quot;All&quot; path=&quot;/&quot; handler={TodoMain} /&gt;<br/>        &lt;ReactRouter.Route name=&quot;Completed&quot; path=&quot;/completed&quot; handler={TodoMain} /&gt;<br/>        &lt;ReactRouter.Route name=&quot;Active&quot; path=&quot;/active&quot; handler={TodoMain} /&gt;<br/>    &lt;/ReactRouter.Route&gt;<br/>);<br/><br/>ReactRouter.run(routes, function(Handler) {<br/>    React.render(&lt;Handler/&gt;, document.getElementById(&#x27;todoapp&#x27;));<br/>});</code></pre><p>All three routes actually render the same component (<code>TodoMain</code> inside <code>TodoApp</code>), but it will act differently depending on the path.</p><h3 id="the-todoapp-component">The TodoApp component</h3><p>Finally we get to the actual React components! First off <code>TodoApp</code>, which is used as a wrapper for all routes:</p><pre><code class="hljs language-javascript"><span class="hljs-comment">// Renders the full application</span><br/><span class="hljs-comment">// RouteHandler will always be TodoMain, but with different &#x27;showing&#x27; prop (all/completed/active)</span><br/><span class="hljs-keyword">var</span> TodoApp = React.createClass({<br/>    <span class="hljs-comment">// this will cause setState({list:updatedlist}) whenever the store does trigger(updatedlist)</span><br/>    mixins: [Reflux.connect(todoListStore,<span class="hljs-string">&quot;list&quot;</span>)],<br/>    <span class="hljs-attr">getInitialState</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">return</span> {<br/>            <span class="hljs-attr">list</span>: []<br/>        };<br/>    },<br/>    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">return</span> (<br/>            &lt;div&gt;<br/>                &lt;TodoHeader /&gt;<br/>                &lt;ReactRouter.RouteHandler list={this.state.list} /&gt;<br/>                &lt;TodoFooter list={this.state.list} /&gt;<br/>            &lt;/div&gt;<br/>        );<br/>    }<br/>});</code></pre><p>Note that <code>TodoApp</code> is listening to <code>todoListStore</code>. That means it will update its state with whatever <code>todoListStore</code> triggers, which will cause a rerender.</p><p>Apart from that there isn&#x27;t much going on - <code>TodoApp</code> has no user interaction, but merely renders <code>TodoHeader</code>, <code>TodoMain</code> and <code>TodoFooter</code>, passing <code>this.state.list</code> along as a property.</p><h3 id="the-todoheader-component">The TodoHeader component</h3><p>This component renders the top part of the app, including the form which creates new todo items by calling the <code>addItem</code> action.</p><pre><code class="hljs language-javascript"><span class="hljs-comment">// Renders the headline and the form for creating new todos.</span><br/><span class="hljs-comment">// Used in TodoApp</span><br/><span class="hljs-comment">// Observe that the toogleall button is NOT rendered here, but in TodoMain (it is then moved up to the header with CSS)</span><br/><span class="hljs-keyword">var</span> TodoHeader = React.createClass({<br/>    <span class="hljs-attr">handleValueChange</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{<br/>        <span class="hljs-keyword">var</span> text = evt.target.value;<br/>        <span class="hljs-keyword">if</span> (evt.which === <span class="hljs-number">13</span> &amp;&amp; text) { <span class="hljs-comment">// hit enter, create new item if field isn&#x27;t empty</span><br/>            TodoActions.addItem(text);<br/>            evt.target.value = <span class="hljs-string">&#x27;&#x27;</span>;<br/>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt.which === <span class="hljs-number">27</span>) { <span class="hljs-comment">// hit escape, clear without creating</span><br/>            evt.target.value = <span class="hljs-string">&#x27;&#x27;</span>;<br/>        }<br/>    },<br/>    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">return</span> (<br/>            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;header&quot;</span>&gt;</span><br/>                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>todos<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br/>                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;new-todo&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;What needs to be done?&quot;</span> <span class="hljs-attr">autoFocus</span> <span class="hljs-attr">onKeyUp</span>=<span class="hljs-string">{this.handleValueChange}/</span>&gt;</span><br/>            <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span><br/>        );<br/>    }<br/>});</span></code></pre><p>Note that the toggleall button, although physically located in the header, is actually defined in <code>TodoMain</code>, and then moved through CSS.</p><p>The reason I suspect is that this way <code>TodoHeader</code> doesn&#x27;t need the todo data at all. Also, if we have no todos at all <code>TodoMain</code> should be hidden as well as the toggleall button, so by making the toggleall button part of <code>TodoMain</code> we don&#x27;t have to duplicate any hiding logic here.</p><h3 id="the-todofooter-component">The TodoFooter component</h3><p>The <code>TodoFooter</code> component shows aggregation information and controls, as well as the navigation bar.</p><pre><code class="hljs language-javascript"><span class="hljs-comment">// Renders the bottom item count, navigation bar and clearallcompleted button</span><br/><span class="hljs-comment">// Used in TodoApp</span><br/><span class="hljs-keyword">var</span> TodoFooter = React.createClass({<br/>    <span class="hljs-attr">propTypes</span>: {<br/>        <span class="hljs-attr">list</span>: React.PropTypes.arrayOf(React.PropTypes.object).isRequired,<br/>    },<br/>    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">var</span> nbrcompleted = _.filter(<span class="hljs-keyword">this</span>.props.list, <span class="hljs-string">&quot;isComplete&quot;</span>).length,<br/>            nbrtotal = <span class="hljs-keyword">this</span>.props.list.length,<br/>            nbrincomplete = nbrtotal-nbrcompleted,<br/>            clearButtonClass = React.addons.classSet({<span class="hljs-attr">hidden</span>: nbrcompleted &lt; <span class="hljs-number">1</span>}),<br/>            footerClass = React.addons.classSet({<span class="hljs-attr">hidden</span>: !nbrtotal }),<br/>            completedLabel = <span class="hljs-string">&quot;Clear completed (&quot;</span> + nbrcompleted + <span class="hljs-string">&quot;)&quot;</span>,<br/>            itemsLeftLabel = nbrincomplete === <span class="hljs-number">1</span> ? <span class="hljs-string">&quot; item left&quot;</span> : <span class="hljs-string">&quot; items left&quot;</span>;<br/>        <span class="hljs-keyword">return</span> (<br/>            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;footer&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{footerClass}</span>&gt;</span><br/>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;todo-count&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{nbrincomplete}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>{itemsLeftLabel}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br/>                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;filters&quot;</span>&gt;</span><br/>                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br/>                        <span class="hljs-tag">&lt;<span class="hljs-name">ReactRouter.Link</span> <span class="hljs-attr">activeClassName</span>=<span class="hljs-string">&quot;selected&quot;</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;All&quot;</span>&gt;</span>All<span class="hljs-tag">&lt;/<span class="hljs-name">ReactRouter.Link</span>&gt;</span><br/>                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br/>                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br/>                        <span class="hljs-tag">&lt;<span class="hljs-name">ReactRouter.Link</span> <span class="hljs-attr">activeClassName</span>=<span class="hljs-string">&quot;selected&quot;</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;Active&quot;</span>&gt;</span>Active<span class="hljs-tag">&lt;/<span class="hljs-name">ReactRouter.Link</span>&gt;</span><br/>                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br/>                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br/>                        <span class="hljs-tag">&lt;<span class="hljs-name">ReactRouter.Link</span> <span class="hljs-attr">activeClassName</span>=<span class="hljs-string">&quot;selected&quot;</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;Completed&quot;</span>&gt;</span>Completed<span class="hljs-tag">&lt;/<span class="hljs-name">ReactRouter.Link</span>&gt;</span><br/>                    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br/>                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br/>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;clear-completed&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{clearButtonClass}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{TodoActions.clearCompleted}</span>&gt;</span>{completedLabel}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br/>            <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span></span><br/>        );<br/>    }<br/>});</code></pre><h3 id="the-todomain-component">The TodoMain component</h3><p>Now finally for the <code>TodoMain</code> component. It renders the previously mentioned toggleall button which is moved through CSS to the header, and also the list of todo items. </p><pre><code class="hljs language-javascript"><span class="hljs-comment">// Renders the todo list as well as the toggle all button</span><br/><span class="hljs-comment">// Used in TodoApp</span><br/><span class="hljs-keyword">var</span> TodoMain = React.createClass({<br/>    <span class="hljs-attr">mixins</span>: [ ReactRouter.State ],<br/>    <span class="hljs-attr">propTypes</span>: {<br/>        <span class="hljs-attr">list</span>: React.PropTypes.arrayOf(React.PropTypes.object).isRequired,<br/>    },<br/>    <span class="hljs-attr">toggleAll</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{<br/>        TodoActions.toggleAllItems(evt.target.checked);<br/>    },<br/>    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">var</span> filteredList;<br/>        <span class="hljs-keyword">switch</span>(<span class="hljs-keyword">this</span>.getPath()){<br/>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;/completed&#x27;</span>:<br/>                filteredList = _.filter(<span class="hljs-keyword">this</span>.props.list,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>)</span>{ <span class="hljs-keyword">return</span> item.isComplete; });<br/>                <span class="hljs-keyword">break</span>;<br/>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;/active&#x27;</span>:<br/>                filteredList = _.filter(<span class="hljs-keyword">this</span>.props.list,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>)</span>{ <span class="hljs-keyword">return</span> !item.isComplete; });<br/>                <span class="hljs-keyword">break</span>;<br/>            <span class="hljs-keyword">default</span>:<br/>                filteredList = <span class="hljs-keyword">this</span>.props.list;<br/>        }<br/>        <span class="hljs-keyword">var</span> classes = React.addons.classSet({<br/>            <span class="hljs-string">&quot;hidden&quot;</span>: <span class="hljs-keyword">this</span>.props.list.length &lt; <span class="hljs-number">1</span><br/>        });<br/>        <span class="hljs-keyword">return</span> (<br/>            &lt;section id=&quot;main&quot; className={classes}&gt;<br/>                &lt;input id=&quot;toggle-all&quot; type=&quot;checkbox&quot; onChange={this.toggleAll} /&gt;<br/>                &lt;label htmlFor=&quot;toggle-all&quot;&gt;Mark all as complete&lt;/label&gt;<br/>                &lt;ul id=&quot;todo-list&quot;&gt;<br/>                    { filteredList.map(function(item){<br/>                        return &lt;TodoItem label={item.label} isComplete={item.isComplete} id={item.key} key={item.key}/&gt;;<br/>                    })}<br/>                &lt;/ul&gt;<br/>            &lt;/section&gt;<br/>        );<br/>    }<br/>});</code></pre><p>Clicking the toggleall button will cause a call to the <code>toggleAllItems</code> action.</p><h3 id="the-todoitem-component">The TodoItem component</h3><p>The final piece of the puzzle is <code>TodoItem</code>, responsible for displaying a single item in the list. It contains lots of user interactions; <code>toggleItem</code>, <code>editItem</code> and <code>removeItem</code>:</p><pre><code class="hljs language-javascript"><span class="hljs-comment">// Renders a single Todo item in the list</span><br/><span class="hljs-comment">// Used in TodoMain</span><br/><span class="hljs-keyword">var</span> TodoItem = React.createClass({<br/>    <span class="hljs-attr">propTypes</span>: {<br/>        <span class="hljs-attr">label</span>: React.PropTypes.string.isRequired,<br/>        <span class="hljs-attr">isComplete</span>: React.PropTypes.bool.isRequired,<br/>        <span class="hljs-attr">id</span>: React.PropTypes.number<br/>    },<br/>    <span class="hljs-attr">mixins</span>: [React.addons.LinkedStateMixin], <span class="hljs-comment">// exposes this.linkState used in render</span><br/>    getInitialState: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">return</span> {};<br/>    },<br/>    <span class="hljs-attr">handleToggle</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{<br/>        TodoActions.toggleItem(<span class="hljs-keyword">this</span>.props.id);<br/>    },<br/>    <span class="hljs-attr">handleEditStart</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{<br/>        evt.preventDefault();<br/>        <span class="hljs-comment">// because of linkState call in render, field will get value from this.state.editValue</span><br/>        <span class="hljs-keyword">this</span>.setState({<br/>            <span class="hljs-attr">isEditing</span>: <span class="hljs-literal">true</span>,<br/>            <span class="hljs-attr">editValue</span>: <span class="hljs-keyword">this</span>.props.label<br/>        }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>            <span class="hljs-keyword">this</span>.refs.editInput.getDOMNode().focus();<br/>        });<br/>    },<br/>    <span class="hljs-attr">handleValueChange</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{<br/>        <span class="hljs-keyword">var</span> text = <span class="hljs-keyword">this</span>.state.editValue; <span class="hljs-comment">// because of the linkState call in render, this is the contents of the field</span><br/>        <span class="hljs-comment">// we pressed enter, if text isn&#x27;t empty we blur the field which will cause a save</span><br/>        <span class="hljs-keyword">if</span> (evt.which === <span class="hljs-number">13</span> &amp;&amp; text) {<br/>            <span class="hljs-keyword">this</span>.refs.editInput.getDOMNode().blur();<br/>        }<br/>        <span class="hljs-comment">// pressed escape. set editing to false before blurring so we won&#x27;t save</span><br/>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt.which === <span class="hljs-number">27</span>) {<br/>            <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">isEditing</span>: <span class="hljs-literal">false</span> },<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<br/>                <span class="hljs-keyword">this</span>.refs.editInput.getDOMNode().blur();<br/>            });<br/>        }<br/>    },<br/>    <span class="hljs-attr">handleBlur</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">var</span> text = <span class="hljs-keyword">this</span>.state.editValue; <span class="hljs-comment">// because of the linkState call in render, this is the contents of the field</span><br/>        <span class="hljs-comment">// unless we&#x27;re not editing (escape was pressed) or text is empty, save!</span><br/>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.isEditing &amp;&amp; text) {<br/>            TodoActions.editItem(<span class="hljs-keyword">this</span>.props.id, text);<br/>        }<br/>        <span class="hljs-comment">// whatever the outcome, if we left the field we&#x27;re not editing anymore</span><br/>        <span class="hljs-keyword">this</span>.setState({<span class="hljs-attr">isEditing</span>:<span class="hljs-literal">false</span>});<br/>    },<br/>    <span class="hljs-attr">handleDestroy</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        TodoActions.removeItem(<span class="hljs-keyword">this</span>.props.id);<br/>    },<br/>    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<br/>        <span class="hljs-keyword">var</span> classes = React.addons.classSet({<br/>            <span class="hljs-string">&#x27;completed&#x27;</span>: <span class="hljs-keyword">this</span>.props.isComplete,<br/>            <span class="hljs-string">&#x27;editing&#x27;</span>: <span class="hljs-keyword">this</span>.state.isEditing<br/>        });<br/>        <span class="hljs-keyword">return</span> (<br/>            &lt;li className={classes}&gt;<br/>                &lt;div className=&quot;view&quot;&gt;<br/>                    &lt;input className=&quot;toggle&quot; type=&quot;checkbox&quot; checked={!!this.props.isComplete} onChange={this.handleToggle} /&gt;<br/>                    &lt;label onDoubleClick={this.handleEditStart}&gt;{this.props.label}&lt;/label&gt;<br/>                    &lt;button className=&quot;destroy&quot; onClick={this.handleDestroy}&gt;&lt;/button&gt;<br/>                &lt;/div&gt;<br/>                &lt;input ref=&quot;editInput&quot; className=&quot;edit&quot; valueLink={this.linkState(&#x27;editValue&#x27;)} onKeyUp={this.handleValueChange} onBlur={this.handleBlur} /&gt;<br/>            &lt;/li&gt;<br/>        );<br/>    }<br/>});</code></pre><p>Note how Mikael cleverly keeps the value of the input field as state, and then acts with that state when the field is blurred. If the user pressed escape or the input is empty then nothing happens, otherwise a call to <code>editItem</code> is made.</p><h3 id="comparing-to-flux">Comparing to Flux</h3><p>Now that you&#x27;ve come to know what the Reflux solution to the TodoMVC problem looks like, take a look at the <a href="http://facebook.github.io/flux/docs/todo-list.html">Flux version</a>. You&#x27;ll find that even though it has the same React advantage, the code base is much more opaque.</p><p>We&#x27;ve also done a more direct <a href="/posts/react-js-architecture-flux-vs-reflux">comparison between Flux and Reflux</a> here on this blog, should you need more convincing.</p><h3 id="wrapping-up">Wrapping up</h3><p>I hope the Reflux TodoMVC app and this walkthrough showcased the strengths of the Reflux approach. I&#x27;ve really come to love React, but it was only when I paired it with Reflux - and ReactRouter and Firebase - that things took off for real.</p><p>Intellectually I realise that I&#x27;m probably just infatuated as usual by the latest shiny toy, but I&#x27;ll say it anyway: I can see myself working on this stack for a long time to come!</p></div><hr/></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/posts/a-reflux-todomvc-codebase-walkthrough","query":{},"buildId":"2QsClKZj9MiqsQHek7Hru","dynamicBuildId":false,"nextExport":true}</script><script async="" id="__NEXT_PAGE__/posts/a-reflux-todomvc-codebase-walkthrough" src="/_next/static/2QsClKZj9MiqsQHek7Hru/pages/posts/a-reflux-todomvc-codebase-walkthrough.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/_next/static/2QsClKZj9MiqsQHek7Hru/pages/_app.js"></script><script src="/_next/static/runtime/webpack-3df6523e264ff2ac6548.js" async=""></script><script src="/_next/static/chunks/commons.71c37b6af41e6d908545.js" async=""></script><script src="/_next/static/runtime/main-313fb35df81e158a12cf.js" async=""></script><div id="disqus_thread" style="display:none"></div></div><script type="text/javascript" async="" src="https://krawaller.disqus.com/embed.js"></script></body></html>